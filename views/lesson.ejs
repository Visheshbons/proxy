<% pageTitle = lesson.title + ' - ' + lesson.subject %>
<%- include('partials/header') %>

<main class="main-container">
  <div class="breadcrumb">
    <a href="/">Home</a> /
    <a href="/subject/<%= subject %>"><%= subject %></a> /
    <a href="/subject/<%= subject %>/year/<%= year %>">Year <%= year %></a> /
    <a href="/subject/<%= subject %>/year/<%= year %>/topic/<%= topic %>"><%= lesson.topic %></a> /
    <span>Lesson <%= lessonNumber %></span>
  </div>

  <article class="lesson-container">
    <header class="lesson-header">
      <div class="lesson-meta">
        <span class="lesson-badge"><%= lesson.subject %></span>
        <span class="lesson-badge">Year <%= lesson.year %></span>
        <span class="lesson-badge">Lesson <%= lesson.lessonNumber %></span>
        <div class="lives-display" id="livesDisplay">
          <span class="life-icon">‚ù§Ô∏è</span>
          <span class="life-icon">‚ù§Ô∏è</span>
        </div>
      </div>
      <h1 class="lesson-title"><%= lesson.title %></h1>
      <p class="lesson-description"><%= lesson.description %></p>
    </header>

    <div class="lesson-content" id="lessonContent">
      <!-- Content sections will be shown one at a time -->
    </div>

    <div id="completionContainer" style="display: none;">
      <div class="completion-message">
        <div class="completion-icon">üéâ</div>
        <h2 class="completion-title">Lesson Complete!</h2>
        <p class="completion-text" id="completionText">Great job! You've successfully completed this lesson.</p>
        <div id="creditsEarned" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%); border-radius: 12px;">
          <div style="font-size: 2rem; margin-bottom: 10px;">üí∞</div>
          <div style="font-size: 1.2rem; font-weight: 600; color: var(--color-primary);">
            You earned <span id="creditsAmount"></span> credits!
          </div>
        </div>
        <a href="/subject/<%= subject %>/year/<%= year %>/topic/<%= topic %>" class="btn btn-secondary">Back to Lessons</a>
      </div>
    </div>

    <div id="restartContainer" style="display: none;">
      <div class="restart-message">
        <h2 class="restart-title">Out of Lives!</h2>
        <p>You've lost all your lives. Don't worry - learning takes practice!</p>
        <button class="restart-button" onclick="restartLesson()">Restart Lesson</button>
      </div>
    </div>
  </article>
</main>

<script>
  // Lesson data
  const lessonData = <%- JSON.stringify(lesson) %>;
  if (typeof isAuthenticated === "undefined") {
    const isAuthenticated = <%- JSON.stringify(isAuthenticated) %>;
  }
  const subject = <%- JSON.stringify(subject) %>;
  const year = <%- JSON.stringify(year) %>;
  const topic = <%- JSON.stringify(topic) %>;
  const lessonNum = <%- JSON.stringify(lessonNumber) %>;

  console.log('Lesson Data:', lessonData);

  // State management
  let currentSectionIndex = 0;
  let currentQuestionIndex = 0;
  let lives = 2;
  let userAnswer = '';
  let answeredCorrectly = false;
  let livesLost = 0;

  // Initialize lesson
  function init() {
    console.log('Initializing lesson...');
    if (!lessonData || !lessonData.content || lessonData.content.length === 0) {
      console.error('No lesson content found!');
      document.getElementById('lessonContent').innerHTML = '<p>Error: Lesson content not found.</p>';
      return;
    }
    showCurrentSection();
  }

  function showCurrentSection() {
    const content = lessonData.content[currentSectionIndex];
    const container = document.getElementById('lessonContent');

    console.log('Current section:', currentSectionIndex, content);

    if (!content) {
      showCompletion();
      return;
    }

    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'content-section';
    sectionDiv.innerHTML = renderSection(content);

    container.innerHTML = '';
    container.appendChild(sectionDiv);

    // Trigger animation
    setTimeout(() => sectionDiv.classList.add('visible'), 50);
  }

  function renderSection(section) {
    let html = `<div class="content-bubble content-${section.type}">`;

    if (section.type === 'introduction') {
      html += `
        <div class="section-icon">üí°</div>
        <p class="section-text">${section.text}</p>
      `;
    } else if (section.type === 'concept') {
      html += `
        <div class="section-icon">üéØ</div>
        ${section.heading ? `<h3 class="section-heading">${section.heading}</h3>` : ''}
        <p class="section-text">${section.text}</p>
      `;
    } else if (section.type === 'example') {
      html += `
        <div class="section-icon">‚úèÔ∏è</div>
        ${section.heading ? `<h3 class="section-heading">${section.heading}</h3>` : ''}
        ${section.problem ? `<div class="example-problem"><strong>Problem:</strong> ${section.problem}</div>` : ''}
        ${section.solution && section.solution.length > 0 ? `
          <div class="example-solution">
            <strong>Solution:</strong>
            <ol>
              ${section.solution.map(step => `<li>${step}</li>`).join('')}
            </ol>
          </div>
        ` : ''}
      `;
    } else if (section.type === 'practice') {
      html += `
        <div class="section-icon">‚úçÔ∏è</div>
        ${section.heading ? `<h3 class="section-heading">${section.heading}</h3>` : ''}
      `;

      if (section.problems && section.problems.length > 0 && Array.isArray(section.problems[0])) {
        // New format: questions with answers
        html += '</div>'; // Close content bubble
        html += renderPracticeQuestion(section.problems[currentQuestionIndex]);
        return html;
      } else if (section.problems && section.problems.length > 0) {
        // Old format: just a list of problems
        html += `
          <ul class="practice-list" style="margin-top: 15px; padding-left: 25px;">
            ${section.problems.map(problem => `<li style="margin-bottom: 10px;">${problem}</li>`).join('')}
          </ul>
        `;
      }
    }

    html += '</div>';

    // Add continue button
    html += `
      <button class="next-button" onclick="nextSection()">
        ${currentSectionIndex === lessonData.content.length - 1 ? 'Complete Lesson' : 'Continue'}
      </button>
    `;

    return html;
  }

  function renderPracticeQuestion(questionData) {
    if (!questionData || questionData.length < 2) {
      console.error('Invalid question data:', questionData);
      return '<p>Error loading question</p>';
    }

    const [question, correctAnswer] = questionData;

    return `
      <div class="question-container">
        <div class="question-text">${question}</div>
        <div style="margin-bottom: 20px;">
          <input
            type="text"
            id="answerInput"
            class="answer-input"
            placeholder="Type your answer here..."
            onkeypress="if(event.key === 'Enter') submitPracticeAnswer()"
            style="width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid var(--color-neutral-200); border-radius: var(--border-radius-sm); background: var(--bg-primary); color: var(--text-primary);"
          />
        </div>
        <div id="feedback" style="display: none;"></div>
        <button class="next-button" id="submitBtn" onclick="submitPracticeAnswer()">Submit Answer</button>
      </div>
    `;
  }

  function submitPracticeAnswer() {
    if (answeredCorrectly) {
      nextPracticeQuestion();
      return;
    }

    const section = lessonData.content[currentSectionIndex];
    if (!section.problems || !section.problems[currentQuestionIndex]) {
      console.error('No question found at index:', currentQuestionIndex);
      return;
    }

    const [question, correctAnswer] = section.problems[currentQuestionIndex];
    const userInput = document.getElementById('answerInput').value.trim();

    if (!userInput) {
      alert('Please enter an answer!');
      return;
    }

    const feedback = document.getElementById('feedback');
    const input = document.getElementById('answerInput');
    const submitBtn = document.getElementById('submitBtn');

    input.disabled = true;

    const isCorrect = userInput.toLowerCase() === String(correctAnswer).toLowerCase();

    if (isCorrect) {
      feedback.className = 'question-feedback correct';
      feedback.textContent = '‚úÖ Correct! Well done!';
      feedback.style.display = 'block';
      input.style.borderColor = 'var(--color-success)';
      answeredCorrectly = true;

      if (currentQuestionIndex < section.problems.length - 1) {
        submitBtn.textContent = 'Next Question';
      } else {
        submitBtn.textContent = currentSectionIndex === lessonData.content.length - 1 ? 'Complete Lesson' : 'Continue';
      }
      submitBtn.onclick = nextPracticeQuestion;
    } else {
      feedback.className = 'question-feedback incorrect';
      feedback.textContent = `‚ùå Incorrect. The correct answer is: ${correctAnswer}`;
      feedback.style.display = 'block';
      input.style.borderColor = 'var(--color-danger)';

      lives--;
      livesLost++;
      updateLivesDisplay();

      if (lives <= 0) {
        showRestart();
      } else {
        answeredCorrectly = true;
        if (currentQuestionIndex < section.problems.length - 1) {
          submitBtn.textContent = 'Next Question';
        } else {
          submitBtn.textContent = currentSectionIndex === lessonData.content.length - 1 ? 'Complete Lesson' : 'Continue';
        }
        submitBtn.onclick = nextPracticeQuestion;
      }
    }
  }

  function nextPracticeQuestion() {
    const section = lessonData.content[currentSectionIndex];
    currentQuestionIndex++;
    answeredCorrectly = false;

    if (currentQuestionIndex >= section.problems.length) {
      currentQuestionIndex = 0;
      nextSection();
    } else {
      showCurrentSection();
    }
  }

  function nextSection() {
    currentSectionIndex++;
    currentQuestionIndex = 0;
    answeredCorrectly = false;

    if (currentSectionIndex >= lessonData.content.length) {
      showCompletion();
    } else {
      showCurrentSection();
    }
  }

  function updateLivesDisplay() {
    const livesDisplay = document.getElementById('livesDisplay');
    const icons = livesDisplay.querySelectorAll('.life-icon');

    icons.forEach((icon, index) => {
      if (index >= lives) {
        icon.classList.add('life-lost');
      }
    });
  }

  async function showCompletion() {
    document.getElementById('lessonContent').style.display = 'none';
    document.getElementById('completionContainer').style.display = 'block';

    const lessonId = [subject, year, topic, lessonNum].join('|');
    const isPerfect = livesLost === 0;

    // Save to database if authenticated, otherwise to localStorage
    if (isAuthenticated) {
      try {
        const response = await fetch('/api/lesson/complete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ lessonId, isPerfect })
        });

        const data = await response.json();
        if (data.success) {
          const creditsDiv = document.getElementById('creditsEarned');
          const creditsAmount = document.getElementById('creditsAmount');
          creditsAmount.textContent = data.creditsEarned;
          creditsDiv.style.display = 'block';

          if (isPerfect) {
            document.getElementById('completionText').textContent =
              'üåü Perfect! You completed this lesson without losing any lives!';
          }
        }
      } catch (error) {
        console.error('Failed to save progress:', error);
      }
    } else {
      // Save to localStorage for guest users
      try {
        const key = 'completedLessons';
        const raw = localStorage.getItem(key);
        const arr = raw ? JSON.parse(raw) : [];
        if (!arr.includes(lessonId)) {
          arr.push(lessonId);
          localStorage.setItem(key, JSON.stringify(arr));
        }
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    }
  }

  function showRestart() {
    document.getElementById('lessonContent').style.display = 'none';
    document.getElementById('restartContainer').style.display = 'block';
  }

  function restartLesson() {
    currentSectionIndex = 0;
    currentQuestionIndex = 0;
    lives = 2;
    livesLost = 0;
    answeredCorrectly = false;

    document.getElementById('lessonContent').style.display = 'block';
    document.getElementById('restartContainer').style.display = 'none';
    document.getElementById('completionContainer').style.display = 'none';

    const icons = document.querySelectorAll('.life-icon');
    icons.forEach(icon => icon.classList.remove('life-lost'));

    showCurrentSection();
  }

  // Start the lesson
  init();
</script>

<%- include('partials/footer') %>
